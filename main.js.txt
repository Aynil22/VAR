const dashboardVideo = document.getElementById('varVideo');
const monitorVideo = document.getElementById('monitorVideo') || null;
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
canvas.width = 1000;
canvas.height = 562;
let laatsteVerdediger = null;
let poses = [];
let posenetModel = null;
const channel = new BroadcastChannel('var_channel');

if(dashboardVideo){
  document.getElementById('slowMoBtn').onclick = () => dashboardVideo.playbackRate = 0.25;
  document.getElementById('normalBtn').onclick = () => dashboardVideo.playbackRate = 1;
  document.getElementById('frameBackBtn').onclick = () => dashboardVideo.currentTime -= 1/60;
  document.getElementById('frameForwardBtn').onclick = () => dashboardVideo.currentTime += 1/60;
  document.getElementById('decisionBtn').onclick = () => { laatsteVerdediger=null; drawOverlay(); sendState(); };
  canvas.addEventListener('click', e=>{ laatsteVerdediger = e.clientX - canvas.getBoundingClientRect().left; drawOverlay(); sendState(); });
  dashboardVideo.addEventListener('timeupdate', ()=>{ drawOverlay(); sendState(); });
  async function loadPoseNet(){ posenetModel = await posenet.load(); detectPose(); }
  async function detectPose(){ if(!posenetModel) return; const pose = await posenetModel.estimateSinglePose(dashboardVideo,{flipHorizontal:false}); poses=[pose]; drawOverlay(); sendState(); requestAnimationFrame(detectPose); }
  dashboardVideo.addEventListener('play', loadPoseNet);
  function sendState(){ channel.postMessage({currentTime:dashboardVideo.currentTime, playbackRate:dashboardVideo.playbackRate, laatsteVerdediger, poses}); }
}

if(monitorVideo){ channel.onmessage = e => { const state = e.data; monitorVideo.currentTime=state.currentTime; monitorVideo.playbackRate=state.playbackRate; laatsteVerdediger=state.laatsteVerdediger; poses=state.poses; drawOverlay(); }; }

function drawOverlay(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(laatsteVerdediger!==null){ ctx.fillStyle = 'rgba(255,255,0,0.3)'; ctx.fillRect(laatsteVerdediger, 0, 5, canvas.height); }
  poses.forEach(p=>{ p.keypoints.forEach(k=>{ if(k.score>0.5){ ctx.fillStyle="red"; ctx.beginPath(); ctx.arc(k.position.x, k.position.y, 5,0,2*Math.PI); ctx.fill(); } }); });
  if(laatsteVerdediger!==null){ poses.forEach(p=>{ const voet = p.keypoints.find(k=>k.part==="leftAnkle") || p.keypoints.find(k=>k.part==="rightAnkle"); if(voet && voet.position.x > laatsteVerdediger){ ctx.fillStyle="rgba(255,0,0,0.5)"; ctx.font="30px Arial"; ctx.fillText("MOGELIJK BUITENSPEL!", 200, 50); } }); }
}